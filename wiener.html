<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BoltView: Wiener Filtering</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BoltView
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('wiener.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Wiener Filtering </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this example we will show how to implement basic version of the Wiener filter to deconvolve a blurred image.</p>
<p float="left" align="center"></p>
<p><img src="./blurred_bee.png" alt="Blurred image" title="Blurred image" height="300" class="inline"/> <img src="./deconvolved_bee.jpg" alt="Deconvolved image" title="Deconvolved image" height="300" class="inline"/> </p>
<p>Wiener filter is applied in frequency domain, so the key part is to do the Fourier transformation of the blurred image and also of point spread function (PSF), which caused the image blur.</p>
<p>We can create the wiener filter as a procedural view which provides on demand modulation factors for each frequency. Procedural view approach is useful when certain computation do not need to be computed right away and can be bundled to some other calculation. The calculation of each factor in Wiener filter is wrapped in the following functor. We use the constant noise suppression factor for all frequencies. </p><div class="fragment"><div class="line">struct WienerFtor {</div>
<div class="line"> </div>
<div class="line">    template&lt;typename TValue&gt;</div>
<div class="line">    BOLT_DECL_HYBRID</div>
<div class="line">    auto operator()(const TValue &amp;val) const {</div>
<div class="line">        return conjugate(val) / (magSquared(val) + noise_factor);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    float noise_factor = 0.0f;</div>
<div class="line">};</div>
</div><!-- fragment --><p>It is a direct implementation of the Wiener formula. The <code>operator()</code> is prefixed with <code>BOLT_DECL_HYBRID</code> which causes its implementation to be compiled for both host and device. We use this functor to instance a template <code>UnaryOperatorImageView&lt;&gt;</code>, which wraps an image view and pixel access executes the functor on the pixel of the underlying image view. </p><div class="fragment"><div class="line">template&lt;typename TPsf&gt;</div>
<div class="line">auto wiener(TPsf psf, float noise_factor) {</div>
<div class="line">    return UnaryOperatorImageView&lt;TPsf, WienerFtor&gt;(psf, WienerFtor{noise_factor});</div>
<div class="line">}</div>
</div><!-- fragment --><p>Inverse filtering in Fourier domain requires the spectra of the input image and the PSF to be of the same size. This is achieved by padding the PSF by zeroes and keeping the center of the PSF at the coordinates [0, 0] and wrap it cyclically. </p><div class="fragment"><div class="line">template&lt;typename TKernel, typename TSize&gt;</div>
<div class="line">BOLT_DECL_HYBRID</div>
<div class="line">auto padConvolutionKernel(TKernel &amp;k, TSize size) {</div>
<div class="line">    auto kernel_view = mirror(makeHostImageConstView(k.pointer(), k.size()), Bool2(true, true));</div>
<div class="line">    auto new_center = k.size() - k .center();</div>
<div class="line">    return paddedView(kernel_view, size, -new_center + Int2(1, 1), 0);</div>
<div class="line">}</div>
</div><!-- fragment --><p><img src="./kernel2.png" alt="PSF" title="PSF" height="100" class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.13-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
